{% extends "main/layout.html" %}

{% block title %}–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã{% endblock %}

{% block content %}
<style>
  /* –û–±—â–∏–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
  .tests-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 0 16px;
  }

  /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∞ */
  .tests-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 20px;
  }

  .tests-header h1 {
    font-size: 1.8rem;
    text-align: center;
    flex: 1;
  }

  .home-btn {
    background: #0069d9;
    color: #fff;
    border: none;
    padding: 10px 14px;
    border-radius: 6px;
    text-decoration: none;
    transition: 0.2s;
    font-size: 0.95rem;
  }

  .home-btn:hover {
    background: #0056b3;
  }

  /* –°–ø–∏—Å–æ–∫ —Ç–µ—Å—Ç–æ–≤ */
  .tests-list {
    list-style: none;
    padding: 0;
    display: grid;
    gap: 12px;
  }

  .test-item {
    display: flex;
    justify-content: space-between;
    align-items: center; /* —Ü–µ–Ω—Ç—Ä–æ–≤–∫–∞ –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    padding: 14px;
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    background: #fff;
    flex-wrap: wrap;
    gap: 10px;
  }

  .test-info {
    flex: 1;
    min-width: 200px;
  }

  .test-title {
    font-weight: 700;
    font-size: 16px;
    color: #111;
  }

  .test-desc {
    font-size: 13px;
    color: #666;
    margin-top: 6px;
  }

  /* –ë–ª–æ–∫ —Å –∫–Ω–æ–ø–∫–∞–º–∏ */
  .test-actions {
    display: flex;
    align-items: center;
    gap: 10px;
    flex-shrink: 0;
  }

  /* –ö–Ω–æ–ø–∫–∏ –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –≤—ã—Å–æ—Ç—ã */
  .btn-view,
  .btn-send {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 40px; /* ‚Üê –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è –≤—ã—Å–æ—Ç–∞ */
    padding: 0 16px;
    font-size: 14px;
    border-radius: 6px;
    cursor: pointer;
    text-decoration: none;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
    box-sizing: border-box;
  }

  .btn-view {
    border: 1px solid #b7d4ff;
    color: #0366d6;
    background: #f8faff;
  }

  .btn-view:hover {
    background: #e9f1ff;
  }

  .btn-send {
    background: #007bff;
    color: #fff;
    border: none;
  }

  .btn-send:hover {
    background: #0069d9;
  }

  /* –ú–æ–¥–∞–ª–∫–∞ */
  #sendModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.45);
    align-items: center;
    justify-content: center;
    padding: 16px;
  }

  #sendModal input {
    width: 100%;
    padding: 10px 14px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 0.95rem;
    box-sizing: border-box;
  }

  #sendModal .modal-content {
    width: 100%;
    max-width: 480px;
    background: white;
    padding: 24px 28px;
    border-radius: 8px;
  }

  /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
  @media (max-width: 600px) {
    .tests-header {
      flex-direction: column;
    }

    .test-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .test-actions {
      width: 100%;
      justify-content: flex-start;
    }

    .btn-view,
    .btn-send {
      width: 100%;
      text-align: center;
    }

    .tests-header h1 {
      font-size: 1.4rem;
    }
  }
</style>




<div class="tests-container">
  <div class="tests-header">
    <h1>–ü—Ä–æ–π–¥–µ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã</h1>
    <a href="{% url 'test_home' %}" class="home-btn">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
  </div>

  {% if tests %}
    <ul class="tests-list">
      {% for t in tests %}
        <li class="test-item">
          <div class="test-info">
            <div class="test-title">{{ t.title }}</div>
            <div class="test-desc">–û—Ç–≤–µ—á–µ–Ω–æ –Ω–∞ {{ t.answers_count }} –≤–æ–ø—Ä–æ—Å–æ–≤</div>
          </div>

          <div class="test-actions">
            <a href="{% url 'test_result' t.id %}" class="btn-view">–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç</a>

            <button class="btn-send send-btn"
                    data-method="email"
                    data-test-id="{{ t.id }}"
                    data-title="{{ t.title }}"
                    style="margin-bottom: 7%;">
              üìß Email
            </button>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p style="text-align:center; color:#666;">–í—ã –µ—â—ë –Ω–µ –ø—Ä–æ—Ö–æ–¥–∏–ª–∏ —Ç–µ—Å—Ç—ã.</p>
  {% endif %}
</div>

<!-- Modal -->
<div id="sendModal">
  <div class="modal-content">
    <h3 id="modalHeading" style="margin:0 0 8px 0;">–û—Ç–ø—Ä–∞–≤–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</h3>
    <p id="modalSubtitle" style="margin:0 0 12px 0; color:#555"></p>

    <div style="margin-bottom:8px;">
      <label for="contactInput" style="display:block; font-weight:600; margin-bottom:6px;">–ö—É–¥–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</label>
      <input id="contactInput" type="text" style="width:100%; padding: 10px; border:1px solid #ddd; border-radius:6px;" />
      <div id="contactHelp" style="font-size:12px; color:#666; margin-top:6px;"></div>
    </div>

    <div style="display:flex; justify-content:flex-end; gap:8px; flex-wrap:wrap;">
      <button onclick="closeModal()" style="padding:8px 12px; border-radius:6px; border:1px solid #ddd; background:#f5f5f5; color:#111;">–û—Ç–º–µ–Ω–∞</button>
      <button id="modalSendBtn" style="padding:8px 12px; border-radius:6px; background:#0069d9; color:white; border:none;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <div id="modalMsg" style="margin-top:12px; font-size:14px;"></div>
  </div>
</div>

<script>
  // --- JS –æ—Å—Ç–∞—ë—Ç—Å—è —Ç–µ–º –∂–µ ---
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  const modal = document.getElementById('sendModal');
  const contactInput = document.getElementById('contactInput');
  const modalHeading = document.getElementById('modalHeading');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const contactHelp = document.getElementById('contactHelp');
  const modalMsg = document.getElementById('modalMsg');
  const modalSendBtn = document.getElementById('modalSendBtn');

  let currentTestId = null;
  let currentMethod = null;

  document.querySelectorAll('.send-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      currentTestId = btn.dataset.testId;
      currentMethod = btn.dataset.method;
      const title = btn.dataset.title;
      openModal(currentMethod, currentTestId, title);
    });
  });

  function openModal(method, testId, title) {
    modal.style.display = 'flex';
    contactInput.value = '';
    modalMsg.textContent = '';
    currentTestId = testId;
    currentMethod = method;

    modalHeading.textContent = method === 'email' ? '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ –ø–æ—á—Ç—É' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ Telegram';
    modalSubtitle.textContent = `–¢–µ—Å—Ç: ${title}`;

    if (method === 'email') {
      contactInput.placeholder = '–í–≤–µ–¥–∏—Ç–µ email (–Ω–∞–ø—Ä–∏–º–µ—Ä: user@example.com)';
      contactHelp.textContent = '–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–∏–¥—ë—Ç –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π email.';
    }
  }

  function closeModal() {
    modal.style.display = 'none';
  }

  modalSendBtn.addEventListener('click', () => {
    const contact = contactInput.value.trim();
    if (!contact) {
      modalMsg.style.color = 'red';
      modalMsg.textContent = '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ.';
      return;
    }
    modalSendBtn.disabled = true;
    modalMsg.style.color = '#333';
    modalMsg.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

    const url = currentMethod === 'email' ? "{% url 'send_result_email' %}" : "{% url 'send_result_telegram' %}";
    const form = new FormData();
    form.append('test_id', currentTestId);
    form.append('contact', contact);

    fetch(url, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken },
      body: form
    }).then(r => r.json())
      .then(data => {
        modalSendBtn.disabled = false;
        if (data.ok) {
          modalMsg.style.color = 'green';
          modalMsg.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!';
          setTimeout(closeModal, 1200);
        } else {
          modalMsg.style.color = 'red';
          modalMsg.textContent = data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ';
        }
      })
      .catch(() => {
        modalSendBtn.disabled = false;
        modalMsg.style.color = 'red';
        modalMsg.textContent = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞';
      });
  });
</script>
{% endblock %}
